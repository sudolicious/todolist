name: $(Date:yyyyMMdd)

trigger:
  branches:
    include:
      - main

pool: Default

variables:
  imageName: 'sudolicious1/todolist-backend'

stages:
- stage: Build
  displayName: 'ğŸ—ï¸ Build Docker Image'
  jobs:
  - job: Build
    displayName: 'Build image'
    steps:
    - checkout: self

    - task: Docker@2
      inputs:
        command: 'build'
        repository: '$(imageName)'
        dockerfile: 'backend/Dockerfile'
        buildContext: 'backend'
        tags: latest
      displayName: 'Build Docker image'

- stage: Push
  displayName: 'ğŸš€ Push to Docker Hub'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: Push
    displayName: 'Push image'
    steps:
    - task: Docker@2
      inputs:
        command: 'login'
        containerRegistry: 'docker-hub-connection'
      displayName: 'Login to Docker Hub'

    - task: Docker@2
      inputs:
        command: 'push'
        repository: '$(imageName)'
        tags: latest
      displayName: 'Push Docker image'

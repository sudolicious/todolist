name: $(Date:yyyyMMdd)-$(GitVersion.MajorMinorPatch)-$(Rev:.r)

trigger:
  branches:
    include:
      - main

pool: Default

variables:
  imageName: 'sudolicious1/todolist-backend'

stages:
# üîñ Get version
- stage: GetVersion
  displayName: 'üîñ Get Version'
  jobs:
  - job: GetVersionJob
    displayName: 'Get version with GitVersion'
    steps:
    - checkout: self
      fetchDepth: 0
      persistCredentials: true
      clean: true
      fetchTags: true

    - script: |
        VERSION=$(dotnet exec /home/olga/.dotnet/tools/.store/gitversion.tool/6.4.0/gitversion.tool/6.4.0/tools/net8.0/any/gitversion.dll /showvariable MajorMinorPatch)
        FULL_VERSION=$(dotnet exec /home/olga/.dotnet/tools/.store/gitversion.tool/6.4.0/gitversion.tool/6.4.0/tools/net8.0/any/gitversion.dll /showvariable FullSemVer)
        CURRENT_DATE=$(date +%Y%m%d)

        echo "##vso[build.updatebuildnumber]${CURRENT_DATE}-${VERSION}-$(Rev:r)"
        echo "APP_VERSION=$VERSION" > $(Build.SourcesDirectory)/version.env
        
        echo "Detected AppVersion: $VERSION"
        echo "Detected FullVersion: $FULL_VERSION"
      name: setVersion
      displayName: 'Get version using GitVersion'

    - publish: $(Build.SourcesDirectory)/version.env
      artifact: version-info
      displayName: 'Publish version info'

# üîí Security Scan
- stage: SecurityScan
  displayName: 'üîí Security Scan'
  dependsOn: GetVersion
  jobs:
  - job: SecurityScan
    displayName: 'Basic Security Checks'
    steps:
    - checkout: self
    - download: current
      artifact: version-info
      displayName: 'Download version info'
    - script: |
        source $(Pipeline.Workspace)/version-info/version.env
        echo "AppVersion: $APP_VERSION"
    - script: |
        echo "Running security checks..."
        gosec -no-fail -exclude-dir=test_integration ./...
        go vet ./...
        go mod verify
        echo "‚úÖ Security scan completed"
      displayName: 'Run security scans'
      workingDirectory: backend

# üèóÔ∏è Build Docker image
- stage: Build
  displayName: 'üèóÔ∏è Build Docker Image'
  dependsOn: SecurityScan
  jobs:
  - job: Build
    displayName: 'Build image'
    steps:
    - checkout: self
    - download: current
      artifact: version-info
      displayName: 'Download version info'
    - script: |
        source $(Pipeline.Workspace)/version-info/version.env
        echo "##vso[task.setvariable variable=DockerAppVersion]$APP_VERSION"
        echo "Building version: $APP_VERSION"
      displayName: 'Set Docker version variable'
    - task: Docker@2
      inputs:
        command: 'login'
        containerRegistry: 'docker-hub-connection'
      displayName: 'Login to Docker Hub'
    - task: Docker@2
      inputs:
        command: 'build'
        repository: '$(imageName)'
        dockerfile: 'backend/Dockerfile'
        buildContext: 'backend'
        tags: |
          $(DockerAppVersion)
          latest
        arguments: '--build-arg APP_VERSION=$(DockerAppVersion)'
      displayName: 'Build Docker image'

# üß™ Integration Test
- stage: IntegrationTest
  displayName: 'üß™ Integration Test'
  dependsOn: Build
  jobs:
  - job: TestBackend
    displayName: 'Integration Tests'
    steps:
    - checkout: self
    - download: current
      artifact: version-info
      displayName: 'Download version info'
    - script: |
        source $(Pipeline.Workspace)/version-info/version.env
        echo "Testing version: $APP_VERSION"
    - script: |
        docker stop test-postgres 2>/dev/null || true
        docker rm test-postgres 2>/dev/null || true
        docker run --name test-postgres \
          -e POSTGRES_USER=$(dbUser) \
          -e POSTGRES_PASSWORD=$(dbPassword) \
          -e POSTGRES_DB=$(dbName) \
          -p $(dbPort):5432 \
          -d postgres:15
      displayName: 'Start PostgreSQL'
    - script: |
        for i in {1..20}; do
          if docker inspect test-postgres --format='{{.State.Running}}' | grep -q 'true'; then
            if docker exec test-postgres pg_isready -U $(dbUser) 2>/dev/null; then
              exit 0
            fi
          fi
          sleep 1
        done
        echo "‚ùå PostgreSQL startup failed"
        docker logs test-postgres || true
        exit 1
      displayName: 'Check PostgreSQL readiness'
    - script: |
        go build -o todolist-app .
        DB_HOST=localhost DB_USER=$(dbUser) DB_PASSWORD=$(dbPassword) DB_NAME=$(dbName) DB_PORT=$(dbPort) DB_SSL_MODE=$(dbSslMode) ./todolist-app &
        echo $! > app.pid
        sleep 5
      displayName: 'Build and start backend'
      workingDirectory: backend
    - script: |
        DB_HOST=localhost DB_USER=$(dbUser) DB_PASSWORD=$(dbPassword) DB_NAME=$(dbName) DB_PORT=$(dbPort) go test -v -tags=integration ./test_integration/ -timeout 30s
      displayName: 'Run health check test'
      workingDirectory: backend
    - script: |
        kill $(cat app.pid) 2>/dev/null || true
        docker stop test-postgres 2>/dev/null || true
        docker rm test-postgres 2>/dev/null || true
      displayName: 'Cleanup'
      condition: always()
      workingDirectory: backend

# üöÄ Push to Docker Hub
- stage: Push
  displayName: 'üöÄ Push to Docker Hub'
  dependsOn: IntegrationTest
  condition: succeeded()
  jobs:
  - job: Push
    displayName: 'Push image'
    steps:
    - download: current
      artifact: version-info
      displayName: 'Download version info'
    - script: |
        source $(Pipeline.Workspace)/version-info/version.env
        echo "##vso[task.setvariable variable=DockerAppVersion]$APP_VERSION"
        echo "Pushing version: $APP_VERSION"
      displayName: 'Set Docker version variable'
    - task: Docker@2
      inputs:
        command: 'login'
        containerRegistry: 'docker-hub-connection'
      displayName: 'Login to Docker Hub'
    - task: Docker@2
      inputs:
        command: 'push'
        repository: '$(imageName)'
        tags: |
          $(DockerAppVersion)
          latest
      displayName: 'Push Docker image'

# üßπ Cleanup images
- stage: Cleanup
  displayName: 'üßπ Cleanup'
  dependsOn: Push
  jobs:
  - job: Cleanup
    displayName: 'Cleanup'
    steps:
    - download: current
      artifact: version-info
      displayName: 'Download version info'
    - script: |
        source $(Pipeline.Workspace)/version-info/version.env
        docker rmi $(imageName):$APP_VERSION 2>/dev/null || true
        docker rmi $(imageName):latest 2>/dev/null || true
        docker image prune -f
      displayName: 'Remove images'
      condition: always()

# üìù Update Helm Chart
- stage: UpdateHelmChart
  displayName: 'üìù Update Helm Chart'
  dependsOn: Push
  condition: succeeded()
  jobs:
  - job: UpdateHelm
    displayName: 'Update Helm chart version'
    steps:
    - checkout: self
      persistCredentials: true
      clean: true
    - download: current
      artifact: version-info
      displayName: 'Download version info'
    - script: |
        source $(Pipeline.Workspace)/version-info/version.env
        echo "Updating Helm chart to version: $APP_VERSION"
        
        git clone https://$(k8s.username):$(k8s.token)@github.com/sudolicious/k8s.git k8s-repo
        cd k8s-repo
        
        sed -i "s|tag:.*|tag: \"$APP_VERSION\"|g" todolist.v2/backend/values.yaml
        
        git config user.email "azure-devops-pipeline@noreply.com"
        git config user.name "Azure DevOps Pipeline"
        
        git add todolist.v2/backend/values.yaml
        git commit -m "ci: update image tag to version $APP_VERSION" || echo "No changes to commit"
        git push origin main
        
        echo "‚úÖ Helm chart tag updated to: $APP_VERSION"
      displayName: 'Update Helm chart version'


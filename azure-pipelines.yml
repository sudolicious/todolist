name: $(Date:yyyyMMdd)-$(GitVersion.MajorMinorPatch)-$(Rev:.r)

trigger:
  branches:
    include:
      - main

pool: Default

variables:
  imageName: 'sudolicious1/todolist-backend'

resources:
  repositories:
    - repository: k8s
      type: git
      name: sudolicious/k8s
      ref: main
      endpoint: 'GitHub'

stages:
# ðŸ”– Get version
- stage: GetVersion
  displayName: 'ðŸ”– Get Version'
  jobs:
  - job: GetVersionJob
    displayName: 'Get version with GitVersion'
    steps:
    - checkout: self
      fetchDepth: 0
      persistCredentials: true
      clean: true
      fetchTags: true

    - script: |
        VERSION=$(dotnet exec /home/olga/.dotnet/tools/.store/gitversion.tool/6.4.0/gitversion.tool/6.4.0/tools/net8.0/any/gitversion.dll /showvariable MajorMinorPatch)
        FULL_VERSION=$(dotnet exec /home/olga/.dotnet/tools/.store/gitversion.tool/6.4.0/gitversion.tool/6.4.0/tools/net8.0/any/gitversion.dll /showvariable FullSemVer)
        CURRENT_DATE=$(date +%Y%m%d)

        echo "##vso[build.updatebuildnumber]${CURRENT_DATE}-${VERSION}-$(Rev:r)"
        echo "##vso[task.setvariable variable=AppVersion;isOutput=true]$VERSION"
        
        echo "APP_VERSION=$VERSION" > version.env
        echo "FULL_VERSION=$FULL_VERSION" >> version.env
        echo "BUILD_DATE=$CURRENT_DATE" >> version.env
        
        echo "Detected AppVersion: $VERSION"


name: $(Date:yyyyMMdd)-$(GitVersion.MajorMinorPatch)-$(Rev:.r)

trigger:
  branches:
    include:
      - main

pool: Default

variables:
  imageName: 'sudolicious1/todolist-backend'
  
stages:
- stage: GetVersion
  displayName: 'ðŸ”– Get Version'
  jobs:
  - job: GetVersionJob
    displayName: 'Get version with GitVersion'
    steps:
    - checkout: self
      fetchDepth: 0
      persistCredentials: true
      clean: true
      fetchTags: true

    - script: |
        VERSION=$(dotnet exec /home/olga/.dotnet/tools/.store/gitversion.tool/6.4.0/gitversion.tool/6.4.0/tools/net8.0/any/gitversion.dll /showvariable MajorMinorPatch)
        FULL_VERSION=$(dotnet exec /home/olga/.dotnet/tools/.store/gitversion.tool/6.4.0/gitversion.tool/6.4.0/tools/net8.0/any/gitversion.dll /showvariable FullSemVer)
        CURRENT_DATE=$(date +%Y%m%d)

        echo "##vso[build.updatebuildnumber]${CURRENT_DATE}-${VERSION}-$(Rev:r)"
        echo "##vso[task.setvariable variable=AppVersion;isOutput=true]$VERSION"
        echo "##vso[task.setvariable variable=FullVersion;isOutput=true]$FULL_VERSION"

        echo "Detected AppVersion: $VERSION"
        echo "Detected FullVersion: $FULL_VERSION"
      name: setVersion
      displayName: 'Get version using GitVersion'

    - publish: version.env
      artifact: version-info
      displayName: 'Publish version info'

# ðŸ”’ Security Scan
- stage: SecurityScan
  displayName: 'ðŸ”’ Security Scan'
  dependsOn: GetVersion
  jobs:
  - job: SecurityScan
    steps:
    - checkout: self

    - download: current
      artifact: version-info

    - script: |
        source version-info/version.env
        echo "##vso[task.setvariable variable=APP_VERSION]$APP_VERSION"
        echo "AppVersion resolved: $(APP_VERSION)"
      displayName: 'Load version variable'

    - script: |
        echo "Running security checks..."
        gosec -no-fail -exclude-dir=test_integration ./...
        go vet ./...
        go mod verify
        echo "âœ… Security scan completed"
      displayName: 'Run security scans'
      workingDirectory: backend

# ðŸ—ï¸ Build
- stage: Build
  displayName: 'ðŸ—ï¸ Build Docker Image'
  dependsOn: SecurityScan
  jobs:
  - job: Build
    steps:
    - checkout: self

    - download: current
      artifact: version-info

    - script: |
        source version-info/version.env
        echo "##vso[task.setvariable variable=APP_VERSION]$APP_VERSION"
        echo "Building version: $(APP_VERSION)"
      displayName: 'Load version variable'

    - task: Docker@2
      inputs:
        command: 'login'
        containerRegistry: 'docker-hub-connection'
      displayName: 'Login to Docker Hub'
    
    - task: Docker@2
      inputs:
        command: 'build'
        repository: '$(imageName)'
        dockerfile: 'backend/Dockerfile'
        buildContext: 'backend'
        tags: |
          $(APP_VERSION)
          latest
        arguments: '--build-arg APP_VERSION=$(APP_VERSION)'
      displayName: 'Build Docker image'

# ðŸ§ª Integration Test
- stage: IntegrationTest
  displayName: 'ðŸ§ª Integration Test'
  dependsOn: Build
  jobs:
  - job: TestBackend
    steps:
    - checkout: self

    - download: current
      artifact: version-info

    - script: |
        source version-info/version.env
        echo "##vso[task.setvariable variable=APP_VERSION]$APP_VERSION"
        echo "Testing version: $(APP_VERSION)"
      displayName: 'Load version variable'

    - script: |
        docker stop test-postgres 2>/dev/null || true
        docker rm test-postgres 2>/dev/null || true
        
        docker run --name test-postgres \
          -e POSTGRES_USER=$(dbUser) \
          -e POSTGRES_PASSWORD=$(dbPassword) \
          -e POSTGRES_DB=$(dbName) \
          -p $(dbPort):5432 \
          -d postgres:15
      displayName: 'Start PostgreSQL'

    - script: |
        for i in {1..20}; do
          if docker inspect test-postgres --format='{{.State.Running}}' | grep -q 'true'; then
            if docker exec test-postgres pg_isready -U $(dbUser) 2>/dev/null; then
              echo "âœ… PostgreSQL is ready!"
              exit 0
            fi
          fi
          echo "Waiting for PostgreSQL... $i seconds"
          sleep 1
        done
        echo "âŒ PostgreSQL startup failed"
        docker logs test-postgres || true
        exit 1
      displayName: 'Check PostgreSQL readiness'

    - script: |
        go build -o todolist-app .
        DB_HOST=localhost DB_USER=$(dbUser) DB_PASSWORD=$(dbPassword) DB_NAME=$(dbName) DB_PORT=$(dbPort) DB_SSL_MODE=$(dbSslMode) ./todolist-app &
        APP_PID=$!
        echo $APP_PID > app.pid
        sleep 5
      displayName: 'Build and start backend'
      workingDirectory: backend

    - script: |
        DB_HOST=localhost DB_USER=$(dbUser) DB_PASSWORD=$(dbPassword) DB_NAME=$(dbName) DB_PORT=$(dbPort) go test -v -tags=integration ./test_integration/ -timeout 30s
      displayName: 'Run health check test'
      workingDirectory: backend

    - script: |
        kill $(cat app.pid) 2>/dev/null || true
        docker stop test-postgres 2>/dev/null || true
        docker rm test-postgres 2>/dev/null || true
      displayName: 'Cleanup'
      condition: always()
      workingDirectory: backend

# ðŸš€ Push
- stage: Push
  displayName: 'ðŸš€ Push to Docker Hub'
  dependsOn: IntegrationTest
  condition: succeeded()
  jobs:
  - job: Push
    steps:
    - download: current
      artifact: version-info

    - script: |
        source version-info/version.env
        echo "##vso[task.setvariable variable=APP_VERSION]$APP_VERSION"
        echo "Pushing version: $(APP_VERSION)"
      displayName: 'Load version variable'

    - task: Docker@2
      inputs:
        command: 'login'
        containerRegistry: 'docker-hub-connection'
      displayName: 'Login to Docker Hub'
    
    - task: Docker@2
      inputs:
        command: 'push'
        repository: '$(imageName)'
        tags: |
          $(APP_VERSION)
          latest
      displayName: 'Push Docker image'

# ðŸ§¹ Cleanup
- stage: Cleanup
  displayName: 'ðŸ§¹ Cleanup'
  dependsOn: Push
  jobs:
  - job: Cleanup
    steps:
    - download: current
      artifact: version-info

    - script: |
        source version-info/version.env
        echo "##vso[task.setvariable variable=APP_VERSION]$APP_VERSION"
        echo "Cleaning version: $(APP_VERSION)"
      displayName: 'Load version variable'

    - script: |
        docker rmi $(imageName):$(APP_VERSION) 2>/dev/null || true
        docker rmi $(imageName):latest 2>/dev/null || true
        docker image prune -f
      displayName: 'Remove images'
      condition: always()


name: $(Date:yyyyMMdd)-$(Rev:.r)

trigger:
  branches:
    include:
      - main

pool: Default

stages:
- stage: GetVersion
  displayName: 'üîñ Get Version'
  jobs:
  - job: GetVersion
    displayName: 'Get version with GitVersion'
    steps:
    - checkout: self
      fetchDepth: 0
      persistCredentials: true
      clean: true
      fetchTags: true

    - script: |
        VERSION=1.2.3   # –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å push
        echo "##vso[task.setvariable variable=AppVersion;isOutput=true]$VERSION"
        echo "Detected AppVersion: $VERSION"
      name: setVersion
      displayName: 'Set fake version'

# üìù Update Helm Chart only
- stage: UpdateHelmChart
  displayName: 'üìù Update Helm Chart'
  dependsOn: GetVersion
  condition: succeeded()
  jobs:
  - job: UpdateHelm
    displayName: 'Update Helm chart version'
    variables:
      AppVersion: $[ stageDependencies.GetVersion.GetVersion.outputs['setVersion.AppVersion'] ]
    steps:
    - script: |
        echo "Updating Helm chart to version: $(AppVersion)"

        # Debug token
        echo "Token length: ${#SYSTEM_ACCESSTOKEN}"
        echo "Token starts with: ${SYSTEM_ACCESSTOKEN:0:5}"

        # Clone k8s repo with service connection
        git clone https://oauth2:$SYSTEM_ACCESSTOKEN@github.com/sudolicious/k8s.git k8s-repo

        cd k8s-repo

        # Update values.yaml
        sed -i "s|tag:.*|tag: \"$(AppVersion)\"|g" todolist.v2/backend/values.yaml

        # Git config
        git config user.email "azure-devops-pipeline@noreply.com"
        git config user.name "Azure DevOps Pipeline"

        # Commit and push
        git add todolist.v2/backend/values.yaml
        git commit -m "ci: update image tag to version $(AppVersion)" || echo "No changes to commit"
        git push origin main

        echo "‚úÖ Helm chart tag updated to: $(AppVersion)"
      displayName: 'Update Helm chart version'
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)

